const e="https://api.pixelplush.dev/v1";let t="PixelPlush Game",a="unknown",o={},r={},i="",s=1920,n=1080,l=.5;var c="",d=!0;let p="",f=!0,m={};function y(e){return Math.floor(Math.random()*Math.floor(e))}function h(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}}async function g(o){let i=Object.keys(z).length;return fetch(`${e}/analytics/heartbeat`,{method:"POST",body:JSON.stringify({session:c,game:a,theme:t,channel:r.channel,players:Object.keys(z),count:i})}).then(e=>e.json())}window.setupGame=function(e,a,c){if(t=e,o=a,r=c,i=o.path||"",r.clouds=void 0===r.clouds||null===r.clouds?!r.overlay:"true"===r.clouds,l=void 0===r.volume||null===r.volume?0:parseInt(r.volume)/100,s=Math.min(window.innerWidth,1920),n=Math.min(window.innerHeight,1080),r.variations&&!r.didRandom){const e=r.variations.split(","),t=y(e.length),a=`${window.location.protocol}//${window.location.host}${window.location.pathname.substr(0,window.location.pathname.lastIndexOf("/"))}/${e[t]}${window.location.search}&didRandom=1`;window.location.href=a}r.readyTime&&(f=!1,setTimeout(()=>{f=!0,ComfyJS.Say("Parachute Drop is ready!")},parseInt(r.readyTime||1e3)))},window.WebFontConfig={custom:{families:["Pixeltype"]},active(){!async function(){if(document.hidden)return void document.addEventListener("visibilitychange",()=>{location.reload()},!1);try{const t=(await fetch("https://www.pixelplush.dev/assets/shamelist.txt").then(e=>e.text())).split(",").map(e=>e.trim().toLowerCase());if(r.channel&&t&&t.includes(r.channel.toLowerCase())&&(console.log("This channel has been blocked for violating the PixelPlush Terms of Service."),d=!1),o.requires)try{if(account=await fetch(`${e}/accounts`,{headers:{Twitch:r.oauth?r.oauth.replace("oauth:",""):void 0}}).then(e=>e.json()),console.log(account),account.error)throw"Login Error";if(!account.owned.includes(o.requires))throw"Item not owned"}catch(e){return void console.log("Auth Validate Failed",e)}!async function(){a="plinko",r.cpPlink&&(m["Plinko!"]={desc:"Drop into the PixelPlush Plinko Game!",color:"#F2C079",cost:parseInt(r.cpPlinkCost||50),callback:(e,t,a,i,s)=>{f&&(d?(x&&r.hideTilStart&&(x=!1,B.forEach(e=>e.visible=!0),D.forEach(e=>e.sprite.visible=!0),o.hideWalls||(W.forEach(e=>e.sprite.visible=!0),Array.isArray(G)?G[X].visible=!0:G.visible=!0,q&&(q.visible=!0)),o.target&&(Array.isArray(C)?(C[I].visible=!0,o.target_animate_on_landed||v()):C.visible=!0,Array.isArray(T)?(T[L].visible=!0,o.target_animate_on_landed||v()):T.visible=!0,P&&(P.visible=!0))),$?S.push({username:s.username,name:e,color:s.userColor||"#ffffff",message:i,emote:s.messageEmotes?Object.keys(s.messageEmotes)[0]:"",emoji:"",extra:s}):ee(s.username,e,s.userColor||"#ffffff",i,s.messageEmotes?Object.keys(s.messageEmotes)[0]:"")):r.oauth&&ComfyJS.Say("The Plinko Bounce game needs your attention. Please contact the PixelPlush team on Discord."))}});r.cpQueue&&(m["Group Plinko"]={desc:"Queue everyone for a group plinko in the PixelPlush Plinko Game!",color:"#F2C079",cost:parseInt(r.cpQueueCost||500),cooldown:parseInt(r.cpQueueCD||120),callback:()=>{if(f)if(d)if($)ComfyJS.Say("/me Group Plinko is already queued.");else{$=!0,Object.keys(z).forEach(e=>{Unicorn.RemoveObject(z[e].player.charName),z[e].pet&&Unicorn.RemoveObject(z[e].pet.charName),Unicorn.RemoveText("name_"+e),delete z[e]}),k&&clearTimeout(k);const e=6e4;ComfyJS.Say(`/me Plinkos are queued for the next 60 seconds. !${r.command||"plinko"} to join!`),setTimeout(()=>{ComfyJS.Say(`/me 30 seconds remaining. !${r.command||"plinko"} to join!`)},e-3e4),setTimeout(()=>{ComfyJS.Say(`/me 10 seconds. !${r.command||"plinko"}`)},e-1e4),setTimeout(()=>{h(S),S.forEach(e=>{ee(e.username,e.name,e.color,e.message,e.emote,e.emoji,e.extra)}),S=[]},e)}else r.oauth&&ComfyJS.Say("The Plinko Bounce game needs your attention. Please contact the PixelPlush team on Discord.")}})}()}catch(e){console.log(e)}Unicorn.Create("unicorn-display",{width:s,height:n,background:"transparent",init:te,update:ae,channel:r.channel,username:r.oauth?r.channel:void 0,password:r.oauth?r.oauth.replace("oauth:",""):void 0,onCommand:w,onChat:A,screenWalls:!1,gravity:{x:0,y:1}}),ComfyJS.onCheer=U,ComfyJS.onConnected=async(e,t,a)=>{if(a){!function(){E=o.target_width||368,j=s/2,O=n-47+(o.target_offset||0),o.target_walls&&(j<E/2+70?j=E/2+70:j>s-E/2-70&&(j=s-E/2-70));if(o.target_versions){const e=y(Object.keys(o.target_versions).length);Object.keys(o.target_versions).forEach((t,a)=>{e===a&&(R=t);let i=o.target_versions[t];if(M[t]={},Array.isArray(i.target))if(o.target_random){let e=y(i.target.length);C=Unicorn.AddBacklay("target"+t+e,"target"+t+e,j,O,{scale:{x:2,y:2}}),C.zIndex=10,C.anchor.set(.5),C.visible=!1,M[t].target=C}else{I=0,C=[];for(let e=0;e<i.target.length;e++){let a=Unicorn.AddBacklay("target"+t+e,"target"+t+e,j,O,{scale:{x:2,y:2}});a.zIndex=10,a.anchor.set(.5),a.visible=!1,C.push(a)}M[t].target=C,C[I].visible=!1,r.hideTilDrop||o.target_animate_on_landed||v()}else C=Unicorn.AddBacklay("target"+t,"target"+t,j,O,{scale:{x:2,y:2}}),C.zIndex=10,C.anchor.set(.5),C.visible=!1,M[t].target=C;if(i.target_overlay)if(Array.isArray(i.target_overlay)){L=0,T=[];for(let e=0;e<i.target_overlay.length;e++){let a=Unicorn.AddBacklay("target_overlay"+t+e,"target_overlay"+t+e,j,O,{scale:{x:2,y:2}});a.zIndex=11,a.anchor.set(.5),a.visible=!1,T.push(a)}M[t].target_overlay=T,T[L].visible=!1,r.hideTilDrop||o.target_animate_on_landed||v()}else T=Unicorn.AddBacklay("target_overlay"+t,"target_overlay"+t,j,O,{scale:{x:2,y:2}}),T.zIndex=11,T.anchor.set(.5),T.visible=!1,M[t].target_overlay=T})}else if(o.target){if(Array.isArray(o.target))if(o.target_random){let e=y(o.target.length);C=Unicorn.AddBacklay("target"+e,"target"+e,j,O,{scale:{x:2,y:2}}),C.zIndex=10,C.anchor.set(.5)}else{I=0,C=[];for(let e=0;e<o.target.length;e++){let t=Unicorn.AddBacklay("target"+e,"target"+e,j,O,{scale:{x:2,y:2}});t.zIndex=10,t.anchor.set(.5),t.visible=!1,C.push(t)}C[I].visible=!0,r.hideTilDrop||o.target_animate_on_landed||v()}else C=Unicorn.AddBacklay("target","target",j,O,{scale:{x:2,y:2}}),C.zIndex=10,C.anchor.set(.5);if(o.target_overlay)if(Array.isArray(o.target_overlay)){L=0,T=[];for(let e=0;e<o.target_overlay.length;e++){let t=Unicorn.AddBacklay("target_overlay"+e,"target_overlay"+e,j,O,{scale:{x:2,y:2}});t.zIndex=11,t.anchor.set(.5),t.visible=!1,T.push(t)}T[L].visible=!0,r.hideTilDrop||o.target_animate_on_landed||v()}else T=Unicorn.AddBacklay("target_overlay","target_overlay",j,O,{scale:{x:2,y:2}}),T.zIndex=11,T.anchor.set(.5)}o.target_front&&(P=Unicorn.AddOverlay("target_front","target_front",j,O,{scale:{x:2,y:2}}),P.anchor.set(.5));if(r.clouds)for(let e=0;e<11;e++){b++;let e=o.clouds[y(o.clouds.length)],t=Unicorn.AddOverlay("cloud_"+b,e,y(s),y(500),{scale:{x:3,y:3}});t.alpha=r.overlay?.5:.9,t.anchor.set(.5),t.speed=.01+.1*Math.random(),t.zIndex=t.speed,B.push(t)}r.hideTilStart&&(B.forEach(e=>e.visible=!1),D.forEach(e=>e.sprite.visible=!1),W.forEach(e=>e.sprite.visible=!1),Array.isArray(G)?G.forEach(e=>e.visible=!1):G.visible=!1,q&&(q.visible=!1));o.target_walls&&(Unicorn.AddObject("TargetTop",{type:"rectangle",x:j,y:O+o.target_walls/2+o.target_collide_land,width:E-50,height:10,isStatic:!0}).sprite.visible=!1,Unicorn.AddObject("TargetLeft",{type:"rectangle",x:j-E/2+27,y:O+o.target_walls,width:10,height:100,isStatic:!0}).sprite.visible=!1,Unicorn.AddObject("TargetRight",{type:"rectangle",x:j+E/2-27,y:O+o.target_walls,width:10,height:100,isStatic:!0}).sprite.visible=!1)}();let e=await g();if(0!==e&&(c=e.session,setInterval(()=>{g()},6e4)),r.oauth){let e=await async function(e){return await fetch("https://id.twitch.tv/oauth2/validate",{headers:{Authorization:`OAuth ${e}`}}).then(e=>e.json()).catch(e=>({error:e}))}(r.oauth.replace("oauth:",""));p=e.client_id,["user:read:email","chat:read","chat:edit","channel:manage:redemptions","channel:read:redemptions"].every(t=>e.scopes.includes(t))||console.log("Need more permissions"),e.expires_in<1800&&console.log("Token expires soon. Need to generate new link")}let t=await ComfyJS.GetChannelRewards(p,!0),a=Object.keys(m);for(let e=0;e<a.length;e++){let o=a[e];if(!t.some(e=>e.title===o))try{await ComfyJS.CreateChannelReward(p,{title:o,prompt:m[o].desc,cost:m[o].cost,is_enabled:!0,background_color:m[o].color,is_user_input_required:!1,is_max_per_stream_enabled:!1,max_per_stream:0,is_max_per_user_per_stream_enabled:!1,max_per_user_per_stream:0,is_global_cooldown_enabled:!!m[o].cooldown,global_cooldown_seconds:m[o].cooldown,should_redemptions_skip_request_queue:!0})}catch(e){console.log(e)}}}},ComfyJS.onReward=(e,t,a,o,r)=>{m[t]&&m[t].callback(e,t,a,o,r)}}()}},function(){const e=document.createElement("script");e.src=`${"https:"===document.location.protocol?"https":"http"}://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js`,e.type="text/javascript",e.async="true";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();let _=null,u=0;function v(e=0){if(_&&clearInterval(_),o.target_versions){Object.keys(M).forEach(e=>{Array.isArray(C)?M[e].target.forEach(e=>{e.visible=!1}):M[e].target.visible=!1,M[e].target_overlay.forEach(e=>{e.visible=!1})});const e=y(Object.keys(M).length);R=Object.keys(M)[e],C=M[R].target,T=M[R].target_overlay,Array.isArray(C)?C[I].visible=!0:C.visible=!0,T[L].visible=!0}_=setInterval(()=>{Array.isArray(C)&&(C[I].visible=!1,I=(I+1)%C.length,C[I].visible=!0),T&&Array.isArray(T)&&(T[L].visible=!1,L=(L+1)%T.length,T[L].visible=!0)},60),e>0&&(u=1e3*e)}let b=0,x=!0,S=[],$=!1;async function w(e,t,a,i,s){if(!i.broadcaster&&!i.mod||"resetplinko"!==t&&"resetboing"!==t||location.reload(),(i.broadcaster||i.mod)&&("deleteplinko"===t||"deleteboing"===t)){let e=await ComfyJS.GetChannelRewards(p,!0),t=Object.keys(m);for(let a=0;a<t.length;a++){let o=t[a],r=e.find(e=>e.title===o);r&&await ComfyJS.DeleteChannelReward(p,r.id)}}if((i.broadcaster||i.mod)&&"unqueueplinko"===t&&$&&(ComfyJS.Say("/me Group plinko is no longer queued."),$=!1),(i.broadcaster||i.mod)&&"queueplinko"===t&&($?ComfyJS.Say("/me Group plinko is already queued."):($=!0,Object.keys(z).forEach(e=>{Unicorn.RemoveObject(z[e].player.charName),z[e].pet&&Unicorn.RemoveObject(z[e].pet.charName),Unicorn.RemoveText("name_"+e),delete z[e]}),k&&clearTimeout(k),ComfyJS.Say("/me Plinkos are queued this game. !startplinko to activate!"))),(i.broadcaster||i.mod)&&"startplinko"===t&&$&&(h(S),S.forEach(e=>{ee(e.username,e.name,e.color,e.message,e.emote,e.emoji,e.extra)}),S=[]),(i.broadcaster||i.mod)&&"testplinko"===t)for(var n=0;n<50;n++)b++,ee("test"+b,"test_"+b,s.userColor||"#ffffff",Object.keys(o.characters)[y(Object.keys(o.characters).length)]);let l=!1;if(!r.commandOn&&r.cpPlink||!r.command||t!==r.command||(l=!0),!r.commandOn&&r.cpPlink||r.command||"plink"!==t&&"plinko"!==t&&"boing"!==t&&"boingboing"!==t||(l=!0),f)if(d){if(l){x&&r.hideTilStart&&(x=!1,B.forEach(e=>e.visible=!0),D.forEach(e=>e.sprite.visible=!0),o.hideWalls||(W.forEach(e=>e.sprite.visible=!0),Array.isArray(G)?G[X].visible=!0:G.visible=!0,q&&(q.visible=!0)),o.target&&(Array.isArray(C)?(C[I].visible=!0,o.target_animate_on_landed||v()):C.visible=!0,Array.isArray(T)?(T[L].visible=!0,o.target_animate_on_landed||v()):T.visible=!0,P&&(P.visible=!0)));const t=twemoji.parse(a,{assetType:"png"});!s.messageEmotes&&t.length>0?$?S.push({username:s.username,name:e,color:s.userColor||"#ffffff",message:a,emote:"",emoji:t[0].url,extra:s}):ee(s.username,e,s.userColor||"#ffffff",a,"",t[0].url):$?S.push({username:s.username,name:e,color:s.userColor||"#ffffff",message:a,emote:s.messageEmotes?Object.keys(s.messageEmotes)[0]:"",emoji:"",extra:s}):ee(s.username,e,s.userColor||"#ffffff",a,s.messageEmotes?Object.keys(s.messageEmotes)[0]:"")}}else l&&r.oauth&&ComfyJS.Say("The Plinko Bounce game needs your attention. Please contact the PixelPlush team on Discord.")}function A(e,t,a,o,r){}function U(e,t,a,o,r){document.hidden}let k=null,E=368,j=0,O=0,C=null,T=null,P=null,I=0,L=0,M={},R=null,z={},J={},F={},B=[],N=[],D=[],W=[],q=null,G=null,X=0,Y=0,Q=0,H=0;function V(e,t,a,o,r,i=""){H++;let s=Math.min(Math.max(1,r),100);Unicorn.AddParticles("Splash_"+H,{blendMode:PIXI.BLEND_MODES.DEFAULT,shape:"cone",angle:-Math.PI/2,spread:Math.PI/2,startColor:e,endColor:t,intensity:s,minSpeed:.05,maxSpeed:.25,gravityX:0,gravityY:3.5,fadeOut:!0,decay:1,image:i||void 0},a,o),function(e,t=2e3){setTimeout(()=>{Unicorn.RemoveParticles(e)},t)}("Splash_"+H,150)}function K(e,t,a,r=""){const i=o.target_boosh_scale||2;o.target_boosh.forEach((a,o)=>{for(let a=0;a<y(5);a++){H++;let o=Unicorn.AddBacklay("boosh_"+H,"target_boosh"+a,e,t+10,{scale:{x:i,y:i}});o.zIndex=11,o.vX=y(50)-25,o.vY=-350+y(100),o.anchor.set(.5),N.push(o)}})}function Z(e,t,a,r=""){const i=o.target_splash_scale||2;o.target_splash.forEach((a,o)=>{for(let a=0;a<y(5);a++){H++;let o=Unicorn.AddBacklay("splash_"+H,"target_splash"+a,e,t+10,{scale:{x:i,y:i}});o.zIndex=11,o.vX=y(100)-50,o.vY=-300+y(100),o.anchor.set(.5),splashes.push(o)}})}async function ee(t,a,n="#ffffff",c,d="",p=""){let f=4/60;if(!z[t]){z[t]={};let h=null,g=null,_=null,u=tinycolor(n),x={};try{let a=await fetch(`${e}/accounts/twitch/design?username=${t}`).then(e=>e.json());a&&(x=a.style||{})}catch(e){console.log(e)}if(x.pet&&x.pet.id&&"pet_none"!==x.pet.id&&(o.pets||(o.pets={}),g=x.pet.id.replace("pet_",""),!o.pets[g])){o.pets[g]={path:x.pet.path,minIdle:x.pet.minIdle,maxIdle:x.pet.maxIdle};for(let e=0;e<10;e++){let t=x.pet.path+"_front";Unicorn.Load(t+e,`${i}/assets/pets/${g}/${t}/${t}${e+1}.png`)}}if(d){if(!J[d]){if(J[d]=!0,d.startsWith("emotesv2_")){let e=`https://static-cdn.jtvnw.net/emoticons/v2/${d}/default/dark/2.0`,o=await fetchGif(e);if(o.length>0){const e=function(e,t){const a=Math.min(...e.map(e=>e.delay)),o=Math.max(...e.map(e=>e.dims.width)),r=Math.max(...e.map(e=>e.dims.height)),i=o,s=r;let n=0;for(let s=0;s<e.length;s++){let l=document.createElement("canvas");l.width=o,l.height=r;let c=l.getContext("2d"),d=c.createImageData(o,r);if(1===e[s].disposalType){let t=s;for(let a=e[t].dims.top;a<r;a++)for(let r=e[t].dims.left;r<o;r++)a>=e[t].dims.top&&r>=e[t].dims.left&&a<e[t].dims.top+e[t].dims.height&&r<e[t].dims.left+e[t].dims.width&&e[t].pixels[a*i+r]!==e[t].transparentIndex?(d.data[a*i*4+4*r+0]=e[t].patch[a*i*4+4*r+0],d.data[a*i*4+4*r+1]=e[t].patch[a*i*4+4*r+1],d.data[a*i*4+4*r+2]=e[t].patch[a*i*4+4*r+2],d.data[a*i*4+4*r+3]=e[t].patch[a*i*4+4*r+3]):0===t&&(d.data[a*i*4+4*r+0]=e[0].patch[a*i*4+4*r+0],d.data[a*i*4+4*r+1]=e[0].patch[a*i*4+4*r+1],d.data[a*i*4+4*r+2]=e[0].patch[a*i*4+4*r+2],d.data[a*i*4+4*r+3]=e[0].patch[a*i*4+4*r+3])}else if(3===e[s].disposalType){let t=null;for(let a=0;a<=s;a++){for(let t=0;t<r;t++)for(let r=0;r<o;r++)if(t>=e[a].dims.top&&r>=e[a].dims.left&&t<e[a].dims.top+e[a].dims.height&&r<e[a].dims.left+e[a].dims.width){const o=(t-e[a].dims.top)*e[a].dims.width+(r-e[a].dims.left),s=(t-e[a].dims.top)*e[a].dims.width*4+4*(r-e[a].dims.left);e[a].pixels[o]!==e[a].transparentIndex?(d.data[t*i*4+4*r+0]=e[a].patch[s+0],d.data[t*i*4+4*r+1]=e[a].patch[s+1],d.data[t*i*4+4*r+2]=e[a].patch[s+2],d.data[t*i*4+4*r+3]=e[a].patch[s+3]):(d.data[t*i*4+4*r+0]=0,d.data[t*i*4+4*r+1]=0,d.data[t*i*4+4*r+2]=0,d.data[t*i*4+4*r+3]=0)}0===a&&(t=d.data.slice())}}else{let t=s;for(let a=e[t].dims.top;a<r;a++)for(let r=e[t].dims.left;r<o;r++){const o=(a-e[t].dims.top)*e[t].dims.width+(r-e[t].dims.left),s=(a-e[t].dims.top)*e[t].dims.width*4+4*(r-e[t].dims.left);a>=e[t].dims.top&&r>=e[t].dims.left&&a<e[t].dims.top+e[t].dims.height&&r<e[t].dims.left+e[t].dims.width&&e[t].pixels[o]!==e[t].transparentIndex&&(d.data[a*i*4+4*r+0]=e[t].patch[s+0],d.data[a*i*4+4*r+1]=e[t].patch[s+1],d.data[a*i*4+4*r+2]=e[t].patch[s+2],d.data[a*i*4+4*r+3]=e[t].patch[s+3])}}c.putImageData(d,0,0);for(let i=0;i<e[s].delay;i+=a)Unicorn.LoadCustom(`${t}${n}`,l,"texture",{width:o,height:r}),n++}return{frames:n,minDelay:a,width:i,height:s}}(o,`emote_${d}`);J[d]={frames:e.frames,framerate:1/60*(1e3/e.minDelay)},setTimeout(()=>{delete z[t],ee(t,a,n,c,d,p)},500)}else Unicorn.Load(`emote_${d}0`,e),setTimeout(()=>{delete z[t],ee(t,a,n,c,d,p)},500)}else{let e=`https://static-cdn.jtvnw.net/emoticons/v1/${d}/2.0`;Unicorn.Load(`emote_${d}0`,e),setTimeout(()=>{delete z[t],ee(t,a,n,c,d,p)},500)}return}let e=[];if(d.startsWith("emotesv2_")&&"boolean"!=typeof J[d]){f=J[d].framerate;for(let t=0;t<J[d].frames;t++)e.push(`emote_${d}${t}`)}else e=[`emote_${d}0`];h=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:1.2,y:1.2},animations:{front:{framerate:f,frames:e,loop:!0}},x:200+y(s-400),y:-100-y(50),z:100,radius:36,onCollide:(e,a,i)=>{if("TargetTop"===e){if(z[t].isLanded=!0,h.collisionFilter.category=1,h.isSensor=!0,h.isStatic=!0,o.target_versions&&v(),o.target_effect){b++;const e=`te_${b}`;let a=Unicorn.AddObject(e,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:4/60,frames:Array.from({length:o.target_effect.length},(e,t)=>`target_effect${t}`),loop:!1,onComplete:()=>{Unicorn.RemoveObject(e)}}},isSensor:!0,isStatic:!0,x:z[t].player.position.x,y:z[t].player.position.y,z:200,radius:.1});a.isSensor=!0,a.animations.front.anchor.y=1}if(R&&o.target_versions[R].target_effect){b++;const e=`te_${b}`;let a=Unicorn.AddObject(e,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:4/60,frames:Array.from({length:o.target_versions[R].target_effect.length},(e,t)=>`target_effect${R}${t}`),loop:!1,onComplete:()=>{Unicorn.RemoveObject(e)}}},isSensor:!0,isStatic:!0,x:z[t].player.position.x,y:z[t].player.position.y,z:200,radius:.1});a.isSensor=!0,a.animations.front.anchor.y=1}if(o.target_animate_on_landed&&v(2),o.target_particles&&V(o.target_particles[0],o.target_particles[1],z[t].player.position.x,z[t].player.position.y+40,10),o.target_boosh&&K(z[t].player.position.x,z[t].player.position.y+40),o.target_splash&&Z(z[t].player.position.x,z[t].player.position.y+40),console.log("Winner: "+t),Unicorn.PlaySound("sfx-win",{volume:l}),r.messageFormat){let e=r.messageFormat.replace("USERNAME",t);setTimeout(()=>{ComfyJS.Say(e)},5e3)}}},onEnter:(e,a)=>{if("bottom_detect"===e&&(z[t].isLanded=!0,h.collisionFilter.category=1,h.isSensor=!0,h.isStatic=!0,o.target_boosh&&K(z[t].player.position.x,z[t].player.position.y+40),1*s/5+s/5-8<h.position.x&&h.position.x<2*s/5+s/5-8&&(console.log("Winner: "+t),Unicorn.PlaySound("sfx-win",{volume:l}),o.target_animate_star_on_landed&&Q++,r.messageFormat))){let e=r.messageFormat.replace("USERNAME",t);setTimeout(()=>{ComfyJS.Say(e)},5e3)}}}),h.charName="player_"+t,h.endImage=`emote_${d}`,h.endScale=1.2}else if(p){if(!F[p])return F[p]=!0,Unicorn.Load(`emoji_${p}`,p),void setTimeout(()=>{delete z[t],ee(t,a,n,c,d,p)},500);h=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:1,y:1},animations:{front:{framerate:f,frames:[`emoji_${p}`],loop:!0}},x:200+y(s-400),y:-100-y(50),z:100,radius:36,onCollide:(e,a,i)=>{if("TargetTop"===e){if(z[t].isLanded=!0,h.collisionFilter.category=1,h.isSensor=!0,h.isStatic=!0,o.target_versions&&v(),o.target_effect){b++;const e=`te_${b}`;let a=Unicorn.AddObject(e,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:4/60,frames:Array.from({length:o.target_effect.length},(e,t)=>`target_effect${t}`),loop:!1,onComplete:()=>{Unicorn.RemoveObject(e)}}},isSensor:!0,isStatic:!0,x:z[t].player.position.x,y:z[t].player.position.y,z:200,radius:.1});a.isSensor=!0,a.animations.front.anchor.y=1}if(R&&o.target_versions[R].target_effect){b++;const e=`te_${b}`;let a=Unicorn.AddObject(e,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:4/60,frames:Array.from({length:o.target_versions[R].target_effect.length},(e,t)=>`target_effect${R}${t}`),loop:!1,onComplete:()=>{Unicorn.RemoveObject(e)}}},isSensor:!0,isStatic:!0,x:z[t].player.position.x,y:z[t].player.position.y,z:200,radius:.1});a.isSensor=!0,a.animations.front.anchor.y=1}if(o.target_animate_on_landed&&v(2),o.target_particles&&V(o.target_particles[0],o.target_particles[1],z[t].player.position.x,z[t].player.position.y+40,10),o.target_boosh&&K(z[t].player.position.x,z[t].player.position.y+40),o.target_splash&&Z(z[t].player.position.x,z[t].player.position.y+40),console.log("Winner: "+t),Unicorn.PlaySound("sfx-win",{volume:l}),r.messageFormat){let e=r.messageFormat.replace("USERNAME",t);setTimeout(()=>{ComfyJS.Say(e)},5e3)}}},onEnter:(e,a)=>{if("bottom_detect"===e&&(z[t].isLanded=!0,h.collisionFilter.category=1,h.isSensor=!0,h.isStatic=!0,o.target_boosh&&K(z[t].player.position.x,z[t].player.position.y+40),1*s/5+s/5-8<h.position.x&&h.position.x<2*s/5+s/5-8&&(console.log("Winner: "+t),Unicorn.PlaySound("sfx-win",{volume:l}),o.target_animate_star_on_landed&&Q++,r.messageFormat))){let e=r.messageFormat.replace("USERNAME",t);setTimeout(()=>{ComfyJS.Say(e)},5e3)}}}),h.charName="player_"+t,h.endImage=`emoji_${p}`,h.endScale=1}else{if(!o.characters[c])if(x.character&&x.character.id){if(!o.characters[x.character.id]){o.characters[x.character.id]=x.character.path;for(let e=0;e<10;e++){let t=o.characters[x.character.id];Unicorn.Load(`${x.character.id}_${e}`,`${i}/assets/characters/${x.character.id}/${t}_front/${t}_front${e+1}.png`)}}c=x.character.id}else c=o.playable[Math.floor(o.playable.length*Math.random())];if(h=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:3,y:3},animations:{front:{framerate:f,frames:[...Array(10).keys()].map(e=>`${c}_${e}`),loop:!0}},x:200+y(s-400),y:-100-y(50),z:100,radius:36,onCollide:(e,a,i)=>{if("TargetTop"===e){if(z[t].isLanded=!0,h.collisionFilter.category=1,h.isSensor=!0,h.isStatic=!0,o.target_versions&&v(),o.target_effect){b++;const e=`te_${b}`;let a=Unicorn.AddObject(e,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:4/60,frames:Array.from({length:o.target_effect.length},(e,t)=>`target_effect${t}`),loop:!1,onComplete:()=>{Unicorn.RemoveObject(e)}}},isSensor:!0,isStatic:!0,x:z[t].player.position.x,y:z[t].player.position.y,z:200,radius:.1});a.isSensor=!0,a.animations.front.anchor.y=1}if(R&&o.target_versions[R].target_effect){b++;const e=`te_${b}`;let a=Unicorn.AddObject(e,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:4/60,frames:Array.from({length:o.target_versions[R].target_effect.length},(e,t)=>`target_effect${R}${t}`),loop:!1,onComplete:()=>{Unicorn.RemoveObject(e)}}},isSensor:!0,isStatic:!0,x:z[t].player.position.x,y:z[t].player.position.y,z:200,radius:.1});a.isSensor=!0,a.animations.front.anchor.y=1}if(o.target_animate_on_landed&&v(2),o.target_particles&&V(o.target_particles[0],o.target_particles[1],z[t].player.position.x,z[t].player.position.y+40,10),o.target_boosh&&K(z[t].player.position.x,z[t].player.position.y+40),o.target_splash&&Z(z[t].player.position.x,z[t].player.position.y+40),console.log("Winner: "+t),Unicorn.PlaySound("sfx-win",{volume:l}),r.messageFormat){let e=r.messageFormat.replace("USERNAME",t);setTimeout(()=>{ComfyJS.Say(e)},5e3)}}},onEnter:(e,a)=>{if("bottom_detect"===e&&(z[t].isLanded=!0,h.collisionFilter.category=1,h.isSensor=!0,h.isStatic=!0,o.target_boosh&&K(z[t].player.position.x,z[t].player.position.y+40),1*s/5+s/5-8<h.position.x&&h.position.x<2*s/5+s/5-8&&(console.log("Winner: "+t),Unicorn.PlaySound("sfx-win",{volume:l}),o.target_animate_star_on_landed&&Q++,r.messageFormat))){let e=r.messageFormat.replace("USERNAME",t);setTimeout(()=>{ComfyJS.Say(e)},5e3)}}}),h.charName="player_"+t,h.endImage=`${c}_0`,h.endScale=3,"boybear"===c||"girlbear"===c){var m=PIXI.utils.string2hex(u.brighten(50).toHexString());h.animations.front.tint=m}if(g){let e={front:[]};for(let t=0;t<10;t++)Object.keys(e).forEach(a=>{e[a].push(o.pets[g].path+"_"+a+t)});_=Unicorn.AddObject("pet_"+t,{type:"circle",scale:{x:3,y:3},animations:{front:{framerate:f,frames:e.front,loop:!0}},x:-1e3,y:-1e3,z:200,radius:24,isStatic:!0}),_.isSensor=!0,_.charName="pet_"+t}}let S=Unicorn.AddText("name_"+t,a,-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:n,lineJoin:"round",stroke:u.getLuminance()<.6?"#ffffff":"#000000",strokeThickness:6});S.anchor.set(.5),h.rotationOffset=Math.random()*Math.PI,z[t]={player:h,label:S,pet:_,petType:g,petOffset:50*Math.random()-25},k&&clearTimeout(k),k=setTimeout(()=>{location.reload()},parseInt(r.cooldown||9e4))}}function te(){if(PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,Unicorn.Load("map",`${i}/assets/${o.bg}.png`),!r.overlay){var e=Unicorn.AddBacklay("map","map",0,n-1080);e.scale.x=3,e.scale.y=3}if(o.target_versions)Object.keys(o.target_versions).forEach(e=>{let t=o.target_versions[e];if(Array.isArray(t.target)){t.target.map((t,a)=>Unicorn.Load("target"+e+a,`${i}/assets/${t}.png`))}else{Unicorn.Load("target"+e,`${i}/assets/${t.target}.png`)}if(Array.isArray(t.target_overlay)){t.target_overlay.map((t,a)=>Unicorn.Load("target_overlay"+e+a,`${i}/assets/${t}.png`))}else{Unicorn.Load("target_overlay"+e,`${i}/assets/${t.target_overlay}.png`)}if(t.target_effect){t.target_effect.map((t,a)=>Unicorn.Load("target_effect"+e+a,`${i}/assets/${t}.png`))}});else if(o.target){if(Array.isArray(o.target)){o.target.map((e,t)=>Unicorn.Load("target"+t,`${i}/assets/${e}.png`))}else{Unicorn.Load("target",`${i}/assets/${o.target}.png`)}if(Array.isArray(o.target_overlay)){o.target_overlay.map((e,t)=>Unicorn.Load("target_overlay"+t,`${i}/assets/${e}.png`))}else{Unicorn.Load("target_overlay",`${i}/assets/${o.target_overlay}.png`)}if(o.target_effect){o.target_effect.map((e,t)=>Unicorn.Load("target_effect"+t,`${i}/assets/${e}.png`))}}o.target_front&&Unicorn.Load("target_front",`${i}/assets/${o.target_front}.png`),o.target_boosh&&o.target_boosh.forEach((e,t)=>{Unicorn.Load("target_boosh"+t,`${i}/assets/${e}.png`)}),o.target_splash&&o.target_splash.forEach((e,t)=>{Unicorn.Load("target_splash"+t,`${i}/assets/${e}.png`)}),o.wall&&Unicorn.Load("wall",`${i}/assets/${o.wall}.png`),o.wallfront&&Unicorn.Load("wallfront",`${i}/assets/${o.wallfront}.png`),Array.isArray(o.peg)?o.peg.forEach((e,t)=>{Unicorn.Load("peg"+t,`${i}/assets/${e}.png`)}):Unicorn.Load("peg",`${i}/assets/${o.peg}.png`),Array.isArray(o.star)?o.star.forEach((e,t)=>{Unicorn.Load("star"+t,`${i}/assets/${e}.png`)}):Unicorn.Load("star",`${i}/assets/${o.star}.png`),Object.keys(o.characters).forEach(e=>{for(let t=0;t<10;t++){let a=o.characters[e];Unicorn.Load(`${e}_${t}`,`${i}/assets/characters/${e}/${a}_front/${a}_front${t+1}.png`)}}),o.clouds.forEach(e=>Unicorn.Load(e,`${i}/assets/${e}.png`)),Unicorn.Load("sfx-peg-bounce",`${i}/assets/${o.peg_sound}`),Unicorn.Load("sfx-win",`${i}/assets/${o.win_sound}`);for(let e=0;e<4;e++){let t,a,i;e%2==0?(t=Math.floor(s/137),a=s/t,i=a,t--):(t=Math.floor((s-137)/137),t--,a=137,i=137+a/2);for(let s=0;s<t;s++){let t="peg";Array.isArray(o.peg)&&(t="peg"+(s+2*e)%o.peg.length);let c=Unicorn.AddObject(`peg_${e}-${s}`,{type:"circle",x:s*a+i,y:n-240-200*e,radius:27,scale:{x:3,y:3},sprite:t,isStatic:!0,density:1/0,friction:1,frictionStatic:.5,frictionAir:.01,onEnter:(e,t)=>{e.startsWith("player_")&&Unicorn.PlaySound("sfx-peg-bounce",{volume:l})}});c.sprite.alpha=r.overlay?.15:1,c.restitution=1.05,c.mass=1/0,c.inverseMass=0,D.push(c)}}if(!o.hideWalls){for(let e=0;e<4;e++){let t=Unicorn.AddObject(`wall_${e}`,{type:"rectangle",x:e*s/5+s/5-8,y:n-60,width:12,height:120,scale:{x:3,y:3},sprite:"wall",isStatic:!0});W.push(t)}o.wallfront&&(q=Unicorn.AddBacklay("wallfront","wallfront",0,n-1080),q.scale.x=s/1920*3,q.scale.y=3)}Unicorn.AddObject("bottom_detect",{type:"rectangle",x:s/2,y:n-2,width:s,height:2,isStatic:!0,isSensor:!0}).sprite.visible=!1;let t=Unicorn.AddObject("left_bound",{type:"rectangle",x:-100,y:n/2,width:200,height:n,isStatic:!0});t.restitution=1.05,t.mass=1/0,t.inverseMass=0,t.sprite.visible=!1;let a=Unicorn.AddObject("right_bound",{type:"rectangle",x:s+100,y:n/2,width:200,height:n,isStatic:!0});if(a.restitution=1.05,a.mass=1/0,a.inverseMass=0,a.sprite.visible=!1,Array.isArray(o.star)){X=0,G=[];for(let e=0;e<o.star.length;e++){let t=Unicorn.AddBacklay(`star${e}`,`star${e}`,s/2+(o.starXOffset||0),n-80+(o.starYOffset||0),{scale:{x:3,y:3}});t.anchor.set(.5),t.visible=!o.hideWalls,G.push(t)}for(let e=0;e<o.star.length;e++)G[e].visible=!1;G[X].visible=!0}else G=Unicorn.AddBacklay("star","star",s/2+(o.starXOffset||0),n-80+(o.starYOffset||0),{scale:{x:3,y:3}}),G.anchor.set(.5),G.visible=!o.hideWalls;Matter.Events.on(physics,"beforeUpdate",(function(e){for(var t in z)z[t].player&&Matter.Body.setVelocity(z[t].player,{x:Math.max(Math.min(z[t].player.velocity.x,30),-30),y:Math.max(Math.min(z[t].player.velocity.y,30),-30)})}))}function ae(e,t){for(var a in z)z[a].player&&(z[a].isLanded,z[a].label.position.x=z[a].player.position.x,z[a].label.position.y=z[a].player.position.y-60,z[a].pet&&(z[a].pet.angle=z[a].player.angle,z[a].pet.position.x=Math.max(20,Math.min(s-20,z[a].player.position.x+z[a].petOffset)),z[a].pet.position.y=z[a].player.position.y+20));B.forEach((e,a)=>{e.x-=t*e.speed,e.x+e.width/2<=0&&(e.x=s+e.width/2,e.y=y(500),e.speed=.01+.1*Math.random(),e.zIndex=e.speed)}),N.forEach(e=>{(e.vY<0||e.y<n-5)&&(e.x+=t/1e3*e.vX,e.y+=t/1e3*e.vY,e.vY<20&&(e.vY+=t/1e3*200))}),Q>0&&Array.isArray(o.star)&&(Y-=t,Y<=0&&(Y+=60,G[X].visible=!1,X=(X+1)%G.length,G[X].visible=!0,o.target_animate_star_on_landed&&0===X&&Q--))}
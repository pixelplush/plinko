let e="Pixel Plinko",t={},a={},n="",o=1920,i=1080,r=.5;function s(e){return Math.floor(Math.random()*Math.floor(e))}window.setupGame=function(s,l,c){e=s,t=l,a=c,n=t.path||"",a.clouds=void 0===a.clouds||null===a.clouds?!a.overlay:a.clouds,r=void 0===a.volume||null===a.volume?0:parseInt(a.volume)/100,o=Math.min(window.innerWidth,1920),i=Math.min(window.innerHeight,1080)},window.WebFontConfig={custom:{families:["Pixeltype"]},active(){Unicorn.Create("unicorn-display",{width:o,height:i,background:"transparent",init:_,update:U,channel:a.channel,username:a.oauth?a.channel:void 0,password:a.oauth,onCommand:f,onChat:h,wallBottom:!0,gravity:{x:0,y:1}}),ComfyJS.onConnected=async(e,n,i)=>{if(i){!function(){if(a.clouds)for(let e=0;e<11;e++){p++;let e=t.clouds[s(t.clouds.length)],n=Unicorn.AddOverlay("cloud_"+p,e,s(o),s(500),{scale:{x:3,y:3}});n.alpha=a.overlay?.5:.9,n.anchor.set(.5),n.speed=.01+.1*Math.random(),n.zIndex=n.speed,b.push(n)}a.hideTilStart&&(b.forEach(e=>e.visible=!1),x.forEach(e=>e.sprite.visible=!1),$.forEach(e=>e.sprite.visible=!1),v.visible=!1)}();let e=await c();0!==e&&(l=e.session,setInterval(()=>{c()},6e4))}}}},function(){const e=document.createElement("script");e.src=`${"https:"===document.location.protocol?"https":"http"}://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js`,e.type="text/javascript",e.async="true";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();var l="";async function c(){let t=Object.keys(m).length;return fetch("https://api.pixelplush.dev/v1/analytics/heartbeat",{method:"POST",body:JSON.stringify({session:l,game:"plinko",theme:e,channel:a.channel,players:Object.keys(m),count:t})}).then(e=>e.json())}let p=0,d=!0;function f(e,n,o,i,r){if(!i.broadcaster&&!i.mod||"resetplinko"!==n&&"resetboing"!==n||location.reload(),(i.broadcaster||i.mod)&&"testplinko"===n)for(var l=0;l<50;l++)p++,w("test"+p,"test_"+p,r.userColor||"#ffffff",Object.keys(t.characters)[s(Object.keys(t.characters).length)]);if("plink"===n||"plinko"===n||"boing"===n||"boingboing"===n){d&&a.hideTilStart&&(d=!1,b.forEach(e=>e.visible=!0),x.forEach(e=>e.sprite.visible=!0),$.forEach(e=>e.sprite.visible=!0),v.visible=!0);const t=twemoji.parse(o,{assetType:"png"});!r.messageEmotes&&t.length>0?w(r.username,e,r.userColor||"#ffffff",o,"",t[0].url):w(r.username,e,r.userColor||"#ffffff",o,r.messageEmotes?Object.keys(r.messageEmotes)[0]:"")}}function h(e,t,a,n,o){}let y=null,m={},u={},g={},b=[],x=[],$=[],v=null;async function w(e,i,l="#ffffff",c,p="",d=""){if(!m[e]){let b=null,x=null,$=null,v=tinycolor(l);if(p){if(!u[p]){u[p]=!0;var f=`https://static-cdn.jtvnw.net/emoticons/v1/${p}/2.0`;return Unicorn.Load(`emote_${p}`,f),void setTimeout(()=>{w(e,i,l,c,p,d)},500)}b=Unicorn.AddObject("player_"+e,{type:"circle",scale:{x:1.2,y:1.2},animations:{front:{framerate:4/60,frames:[`emote_${p}`],loop:!0}},x:200+s(o-400),y:-100-s(50),z:100,radius:36}),b.endImage=`emote_${p}`,b.endScale=1.2}else if(d){if(!g[d])return g[d]=!0,Unicorn.Load(`emoji_${d}`,d),void setTimeout(()=>{w(e,i,l,c,p,d)},500);b=Unicorn.AddObject("player_"+e,{type:"circle",scale:{x:1,y:1},animations:{front:{framerate:4/60,frames:[`emoji_${d}`],loop:!0}},x:200+s(o-400),y:-100-s(50),z:100,radius:36}),b.endImage=`emoji_${d}`,b.endScale=1}else{if(!t.characters[c]){let a={};try{let t=await fetch(`https://api.pixelplush.dev/v1/accounts/twitch/design?username=${e}`).then(e=>e.json());t&&(a=t.style||{})}catch(e){console.log(e)}if(a.character&&a.character.id){if(!t.characters[a.character.id]){t.characters[a.character.id]=a.character.path;for(let e=0;e<10;e++){let o=t.characters[a.character.id];Unicorn.Load(`${a.character.id}_${e}`,`${n}/assets/characters/${a.character.id}/${o}_front/${o}_front${e+1}.png`)}}c=a.character.id}else c=t.playable[Math.floor(t.playable.length*Math.random())];if(a.pet&&a.pet.id&&(t.pets||(t.pets={}),x=a.pet.id.replace("pet_",""),!t.pets[x])){t.pets[x]={path:a.pet.path,minIdle:a.pet.minIdle,maxIdle:a.pet.maxIdle};for(let e=0;e<10;e++){let t=a.pet.path+"_front";Unicorn.Load(t+e,`${n}/assets/pets/${x}/${t}/${t}${e+1}.png`)}}}if(b=Unicorn.AddObject("player_"+e,{type:"circle",scale:{x:3,y:3},animations:{front:{framerate:4/60,frames:[...Array(10).keys()].map(e=>`${c}_${e}`),loop:!0}},x:200+s(o-400),y:-100-s(50),z:100,radius:36,onEnter:(t,n)=>{if("bottom_detect"===t&&(m[e].isLanded=!0,b.isSensor=!0,b.isStatic=!0,1*o/5+o/5-8<b.position.x&&b.position.x<2*o/5+o/5-8&&(console.log("Winner: "+e),Unicorn.PlaySound("sfx-win",{volume:r}),a.messageFormat))){let t=a.messageFormat.replace("USERNAME",e);setTimeout(()=>{ComfyJS.Say(t)},5e3)}}}),b.endImage=`${c}_0`,b.endScale=3,"boybear"===c||"girlbear"===c){var h=PIXI.utils.string2hex(v.brighten(50).toHexString());b.animations.front.tint=h}if(x){let e={front:[]};for(let a=0;a<10;a++)Object.keys(e).forEach(n=>{e[n].push(t.pets[x].path+"_"+n+a)});$=Unicorn.AddObject("pet_"+name,{type:"circle",scale:{x:3,y:3},animations:{front:{framerate:4/60,frames:e.front,loop:!0}},x:-1e3,y:-1e3,z:200,radius:24,isStatic:!0}),$.isSensor=!0}}let _=Unicorn.AddText("name_"+e,i,-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:l,lineJoin:"round",stroke:v.getLuminance()<.6?"#ffffff":"#000000",strokeThickness:6});_.anchor.set(.5),b.rotationOffset=Math.random()*Math.PI,m[e]={player:b,label:_,pet:$,petType:x,petOffset:50*Math.random()-25},y&&clearTimeout(y),y=setTimeout(()=>{location.reload()},9e4)}}function _(){if(PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,Unicorn.Load("map",`${n}/assets/${t.bg}.png`),!a.overlay){var e=Unicorn.AddBacklay("map","map",0,i-1080);e.scale.x=3,e.scale.y=3}Unicorn.Load("wall",`${n}/assets/${t.wall}.png`),t.wallfront&&Unicorn.Load("wallfront",`${n}/assets/${t.wallfront}.png`),Array.isArray(t.peg)?t.peg.forEach((e,t)=>{Unicorn.Load("peg"+t,`${n}/assets/${e}.png`)}):Unicorn.Load("peg",`${n}/assets/${t.peg}.png`),Unicorn.Load("star",`${n}/assets/${t.star}.png`),Object.keys(t.characters).forEach(e=>{for(let a=0;a<10;a++){let o=t.characters[e];Unicorn.Load(`${e}_${a}`,`${n}/assets/characters/${e}/${o}_front/${o}_front${a+1}.png`)}}),t.clouds.forEach(e=>Unicorn.Load(e,`${n}/assets/${e}.png`)),Unicorn.Load("sfx-peg-bounce",`${n}/assets/${t.peg_sound}`),Unicorn.Load("sfx-win",`${n}/assets/${t.win_sound}`);for(let e=0;e<4;e++){let n,s,l;e%2==0?(n=Math.floor(o/137),s=o/n,l=s,n--):(n=Math.floor((o-137)/137),n--,s=137,l=137+s/2);for(let o=0;o<n;o++){let n="peg";Array.isArray(t.peg)&&(n="peg"+(o+2*e)%t.peg.length);let c=Unicorn.AddObject(`peg_${e}-${o}`,{type:"circle",x:o*s+l,y:i-240-200*e,radius:27,scale:{x:3,y:3},sprite:n,isStatic:!0,density:1/0,friction:1,frictionStatic:.5,frictionAir:.01,onEnter:(e,t)=>{e.startsWith("player_")&&Unicorn.PlaySound("sfx-peg-bounce",{volume:r})}});c.sprite.alpha=a.overlay?.15:1,c.restitution=1.05,c.mass=1/0,c.inverseMass=0,x.push(c)}}for(let e=0;e<4;e++){let t=Unicorn.AddObject(`wall_${e}`,{type:"rectangle",x:e*o/5+o/5-8,y:i-60,width:12,height:120,scale:{x:3,y:3},sprite:"wall",isStatic:!0});$.push(t)}if(t.wallfront){var s=Unicorn.AddBacklay("wallfront","wallfront",0,i-1080);s.scale.x=3,s.scale.y=3}Unicorn.AddObject("bottom_detect",{type:"rectangle",x:o/2,y:i-2,width:o,height:2,isStatic:!0,isSensor:!0}).sprite.visible=!1;let l=Unicorn.AddObject("left_bound",{type:"rectangle",x:-100,y:i/2,width:200,height:i,isStatic:!0});l.restitution=1.05,l.mass=1/0,l.inverseMass=0,l.sprite.visible=!1;let c=Unicorn.AddObject("right_bound",{type:"rectangle",x:o+100,y:i/2,width:200,height:i,isStatic:!0});c.restitution=1.05,c.mass=1/0,c.inverseMass=0,c.sprite.visible=!1,v=Unicorn.AddBacklay("star","star",o/2,i-80,{scale:{x:3,y:3}}),v.anchor.set(.5),Matter.Events.on(physics,"beforeUpdate",(function(e){for(var t in m)Matter.Body.setVelocity(m[t].player,{x:Math.max(Math.min(m[t].player.velocity.x,30),-30),y:Math.max(Math.min(m[t].player.velocity.y,30),-30)})}))}function U(e,t){for(var a in m)m[a].isLanded,m[a].label.position.x=m[a].player.position.x,m[a].label.position.y=m[a].player.position.y-60,m[a].pet&&(m[a].pet.angle=m[a].player.angle,m[a].pet.position.x=Math.max(20,Math.min(o-20,m[a].player.position.x+m[a].petOffset)),m[a].pet.position.y=m[a].player.position.y+20);b.forEach((e,a)=>{e.x-=t*e.speed,e.x+e.width/2<=0&&(e.x=o+e.width/2,e.y=s(500),e.speed=.01+.1*Math.random(),e.zIndex=e.speed)})}